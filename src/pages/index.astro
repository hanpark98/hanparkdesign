---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Welcome">
  <section id="home-hero" class="w-full flex flex-col bg-white full-viewport section-clip" style="position:relative;">

    <div id="home-bar" class="w-full">
      <div class="home-bar">
        <a href="/" class="home-brand" aria-label="홈">
          <img src="/images/website/logo.svg" alt="" class="home-logo" />
          <span class="home-brand-title">Han Park</span>
        </a>
        <nav class="home-nav">
          <a class="home-link" href="/profile">Profile</a>
          <a class="home-link" href="/posts">Projects</a>
        </nav>
      </div>
    </div>

    <div class="anim-wrap">
      <div class="anim-panel">
        <div class="text-block">
          <p>
            Graphic Design is more than just a visual. It is an interaction between the product and the user, where every pixel tells a story.
          </p>
        </div>
      </div>
    </div>

    <script>
      (() => {
        const root = document.documentElement;
        function setVH() {
          const h = (window.visualViewport?.height || window.innerHeight);
          root.style.setProperty('--vh', (h * 0.01) + 'px');
        }
        function setBarH() {
          const bar = document.getElementById('home-bar');
          if (!bar) return;
          const h = Math.round(bar.getBoundingClientRect().height);
          root.style.setProperty('--bar-h-actual', h + 'px');
        }
        const init = () => { setVH(); setBarH(); };
        const barEl = document.getElementById('home-bar');
        if (barEl && 'ResizeObserver' in window) {
          const ro = new ResizeObserver(setBarH);
          ro.observe(barEl);
        }
        window.addEventListener('resize', setVH, { passive: true });
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', setVH, { passive: true });
        }
        window.addEventListener('orientationchange', () => setTimeout(setVH, 250), { passive: true });
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>

    <script>
      (() => {
        const RADIUS = 100;
        const MAX_DUR = 600;
        const MIN_DUR = 200;
        const SCRAMBLE_GLYPH = ":";
        const REVERT_MIN_MS = 5000;
        const REVERT_MAX_MS = 6000;
        const REVERT_MIN_MS_TOUCH = 6000;
        const REVERT_MAX_MS_TOUCH = 7500;
        const MOBILE_REVEAL_DELAY = 500;
        const REVERT_BACK_DUR = 220;

        const mql = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : null;
        const prefersReduced = !!(mql && mql.matches);
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        const isASCII = (ch) => ch && ch.charCodeAt(0) <= 0x7F;
        const debounce = (fn, wait)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; };

        function boot(){
          const textRoot = document.querySelector('#home-hero .text-block');
          if (!textRoot) return;
          const p = textRoot.querySelector('p');
          if (!p) return;

          const panel = document.querySelector('#home-hero .anim-panel');
          if (panel){
            panel.classList.add('is-clickable');
            panel.addEventListener('click', () => { window.location.href = '/posts'; });
          }

          const original = p.textContent || '';
          const sr = document.createElement('p');
          sr.className = 'sr-only';
          sr.textContent = original;
          p.setAttribute('aria-hidden', 'true');
          textRoot.insertBefore(sr, p);

          function splitWithWordsAndBr(node){
            const frag = document.createDocumentFragment();

            function makeASCIIChar(ch){
              const wrap = document.createElement('span');
              wrap.className = 'char ascii';
              wrap.dataset.state = 'gib';
              const gib = document.createElement('span');
              gib.className = 'g gib';
              gib.textContent = SCRAMBLE_GLYPH;
              const orig = document.createElement('span');
              orig.className = 'g orig';
              orig.textContent = ch;
              wrap.appendChild(gib);
              wrap.appendChild(orig);
              return wrap;
            }

            function pushSpaces(seq){
              for (let i=0; i<seq.length; i++){
                const span = document.createElement('span');
                span.className = 'char ws';
                span.textContent = seq[i];
                frag.appendChild(span);
              }
            }

            function pushWord(seq){
              const w = document.createElement('span');
              w.className = 'word';
              for (let i=0; i<seq.length; i++){
                const ch = seq[i];
                if (prefersReduced || !isASCII(ch)){
                  const span = document.createElement('span');
                  span.className = 'char fixed';
                  span.textContent = ch;
                  w.appendChild(span);
                } else {
                  w.appendChild(makeASCIIChar(ch));
                }
              }
              frag.appendChild(w);
            }

            function tokenize(text){
              const tokens = text.split(/(\s+)/);
              tokens.forEach(tok=>{
                if (!tok) return;
                if (/^\s+$/.test(tok)) pushSpaces(tok);
                else pushWord(tok);
              });
            }

            function walk(n){
              if (n.nodeType === 3){
                const t = (n.nodeValue || '').replace(/\s*\n+\s*/g, ' ');
                if (t) tokenize(t);
              } else if (n.nodeType === 1){
                if (n.tagName === 'BR'){
                  const br = document.createElement('br');
                  br.className = 'hard-br';
                  frag.appendChild(br);
                } else {
                  Array.from(n.childNodes).forEach(walk);
                }
              }
            }
            Array.from(node.childNodes).forEach(walk);
            node.replaceChildren(frag);
          }
          splitWithWordsAndBr(p);

          const asciiChars = Array.from(p.querySelectorAll('.char.ascii'));
          let boxes = [];
          function measure(){
            boxes = asciiChars.map((el)=>{
              const r = el.getBoundingClientRect();
              return { el, cx: r.left + r.width / 2, cy: r.top + r.height / 2 };
            });
          }
          requestAnimationFrame(measure);
          window.addEventListener('resize', debounce(()=>requestAnimationFrame(measure), 150));

          function clearRevert(el){ if (el._rt){ clearTimeout(el._rt); el._rt = null; } }
          function revertToGib(el, dur){
            const gib = el.querySelector('.g.gib');
            const orig = el.querySelector('.g.orig');
            if (!gib || !orig) return;
            gib.style.transition = orig.style.transition = `opacity ${dur}ms linear`;
            gib.style.opacity = '1'; orig.style.opacity = '0';
            el.dataset.state = 'gib';
            clearRevert(el);
          }
          function resolveToOrig(el, dur){
            if (el.dataset.state === 'orig') return;
            const gib = el.querySelector('.g.gib');
            const orig = el.querySelector('.g.orig');
            if (!gib || !orig) return;
            gib.style.transition = orig.style.transition = `opacity ${dur}ms linear`;
            gib.style.opacity = '0'; orig.style.opacity = '1';
            el.dataset.state = 'orig';
            const min = isTouch ? REVERT_MIN_MS_TOUCH : REVERT_MIN_MS;
            const max = isTouch ? REVERT_MAX_MS_TOUCH : REVERT_MAX_MS;
            clearRevert(el);
            el._rt = setTimeout(() => revertToGib(el, REVERT_BACK_DUR), randMs(min, max));
          }
          function randMs(min, max) { return Math.floor(min + Math.random() * (max - min)); }

          if (!isTouch){
            textRoot.addEventListener('pointermove', (e)=>{
              const ex = e.clientX, ey = e.clientY;
              for (let i=0;i<boxes.length;i++){
                const b = boxes[i];
                const dist = Math.hypot(ex - b.cx, ey - b.cy);
                if (dist < RADIUS){
                  const dur = Math.round(MIN_DUR + (1 - dist/RADIUS) * (MAX_DUR - MIN_DUR));
                  resolveToOrig(b.el, dur);
                }
              }
            });
          } else {
            const io = new IntersectionObserver((ents)=>{
              ents.forEach(e=>{
                if (e.isIntersecting){
                  setTimeout(() => {
                    asciiChars.forEach((el) => {
                      setTimeout(() => resolveToOrig(el, 320 + Math.random() * 860), Math.random() * 720);
                    });
                  }, MOBILE_REVEAL_DELAY);
                  io.disconnect();
                }
              });
            }, { threshold: 0.25 });
            io.observe(textRoot);
          }
        }
        boot();
      })();
    </script>

    <style>
      #home-bar{
        --bar-bg: #ebe9e5; --bar-fg: #040404; --link-fg: #040404;
        --logo-size: clamp(28px, 3.7vw, 30px); --brand-gap: 12px;
        --title-size: clamp(22px, 3.5vw, 25px); --link-size: clamp(17px, 2.4vw, 18px);
      }
      #home-hero{
        --bar-h: clamp(200px, 20vw, 600px);
        --anim-margin-bg: #ebe9e5; --anim-text: #ffffff; --anim-margin: 24px;
        --anim-radius: 16px; --anim-inner-pad-x: 40px;
        --anim-inner-gradient: linear-gradient(to bottom, #040404 0%, #040404 18%, #13151e 34%, #2f3756 50%, #747e89 68%, #c3c0ba 82%, #ebe9e5 95%, #f8f7f3 100%);
        --anim-grain-opacity: .10;
      }
      #home-bar .home-bar{
        padding: 30px 30px 0 30px; min-height: var(--bar-h); background: var(--bar-bg);
        display: flex; align-items: flex-start; justify-content: space-between;
      }
      #home-bar .home-brand{ display:flex; align-items:center; gap: var(--brand-gap); color: var(--bar-fg); text-decoration: none; }
      #home-bar .home-logo{ height: var(--logo-size); width:auto; }
      #home-bar .home-brand-title{ font-weight: 600; font-size: var(--title-size); line-height: 1; }
      #home-bar .home-nav{ display:flex; }
      #home-bar .home-link{ color: var(--link-fg); font-size: var(--link-size); font-weight: 600; text-decoration: none; margin-left: 18px; }

      .anim-wrap{
        display:flex; align-items:center; justify-content:center; padding: var(--anim-margin);
        background: var(--anim-margin-bg); box-sizing: border-box; overflow: hidden;
        min-height: calc(var(--vh, 1vh) * 100 - var(--bar-h-actual, var(--bar-h)));
        height: calc(var(--vh, 1vh) * 100 - var(--bar-h-actual, var(--bar-h)));
      }
      .anim-panel{
        width: 100%; height: 100%; background: var(--anim-inner-gradient); border-radius: var(--anim-radius);
        display:flex; align-items:center; justify-content:center; padding: 0 var(--anim-inner-pad-x);
        position: relative; overflow: hidden; transform: translateZ(0);
      }
      .anim-panel::after{
        content:""; position:absolute; inset:0; pointer-events:none;
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>");
        background-size: 200px 200px; mix-blend-mode: multiply; opacity: var(--anim-grain-opacity);
      }
      .text-block{
        max-width: 1000px; margin: 0 auto; text-align: center;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-weight: 300; font-size: clamp(16px, 4vw, 40px); line-height: 1.45; color: var(--anim-text);
      }
    </style>

    <style is:global>
      /* 문자 컨테이너 */
      #home-hero .char{ display:inline-block; vertical-align: baseline; }
      #home-hero .char.ascii{ position: relative; width: 1ch; height: 1em; }
      #home-hero .char.ascii .g{ position: absolute; inset:0; will-change: opacity; }
      #home-hero .char.ascii .g.gib{ opacity: 1; }
      #home-hero .char.ascii .g.orig{ opacity: 0; }
      #home-hero .char.ws{ display:inline-block; white-space: pre; }

      /* === [수정 핵심] 단어 단위 래핑 설정 === */
      #home-hero .word {
        display: inline-block;  /* 단어를 한 덩어리로 취급 */
        white-space: nowrap;    /* 단어 내부 글자들 줄바꿈 방지 */
      }

      #home-hero .hard-br{ display: none; }
      @media (min-width: 640px){ #home-hero .hard-br{ display: initial; } }
      .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    </style>
  </section>
</Layout>